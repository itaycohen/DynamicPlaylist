function dpSongsListLogic(e,n,r){function t(){p(),a(),h(),v(),q(),S()}function a(){for(var n,r=0,t=F(),a=0;a<t.length;a++)t[a]>0&&r++;switch(r){case 1:n=6.5;break;case 2:n=7;break;case 3:n=9;break;case 4:n=10;break;case 5:n=11;break;default:n=7}e.weightDistanceFactor=n}function s(){if(X()){var e=o(Q()),n=i(e[0]),r=e[1];u([n,r],!0)}else u([ae,se],!1)}function i(e){for(var n=0,r=0;r<e.length;r++){var t=e[r];0===t&&(e[r]=-1),t>0&&n++}var a=[];if(n>ue){for(var s=0;s<e.length;s++){var i={};i={i:s,g:e[s]},a[s]=i}a.sort(function(e,n){return e.g-n.g});for(var o=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,-1),u=0;u<5;u++)topGenreArrPair=a[a.length-(u+1)],o[topGenreArrPair.i]=topGenreArrPair.g;return o}return e}function o(n){var r=e.rawSongsList,t=Y();if(songDataByIndexOfUrl=r[Y()],t===songDataByIndexOfUrl.i)return[songDataByIndexOfUrl.g,songDataByIndexOfUrl.t];consolo.error("the index in the array of all songs is not the same as in the song data");for(var a;a<r.length;a++){var s=r[a];if(s.id===n)return[s.g,s.t]}}function u(n,r){if(e.userGenresMap=n[0],e.userTagsMap=n[1],localStorage){if(!r){var t=localStorage.getItem(ie);if(Z(t)){var a;try{if(a=JSON.parse(t),g(a))return e.userGenresMap=a.genres,void(e.userTagsMap=a.tags);f()}catch(e){console.error("Error: "+e+" | Unable to parse local storage data. value: "+t)}}}f()}}function g(e){return c(e.genres)&&l(e.tags)}function c(e){return e.length===re.length}function l(e){return Object.keys(e).length===te.length}function f(){var n={};n.genres=e.userGenresMap,n.tags=e.userTagsMap;try{localStorage.setItem(ie,JSON.stringify(n))}catch(e){console.error("Error: "+e+" | Unable to set item to local storage data")}}function d(){return e.songsIndexesList}function p(){var n=e.rawSongsList.length,r=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=r}function h(){for(var n=[],r=e.rawSongsList,t=r.length,a=F(),s=0;s<t;s++){var i=r[s],o=i.g,u=x(o,a);n.push({index:s,score:u})}e.genreWeightsDistancesList=n}function v(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function x(e,n){for(var r=0,t=0,a=y(e),s=0;s<n.length;s++){var i=n[s],o=e[s];if(i>0&&o>0){r=Math.pow(5-Math.abs(i-o),2);var u=a>0?o/a:1;t+=i===o?(r+10)*u:r*u}else 0!==i&&i!==-1||0!==o?0!==i&&0!==o||(r=5-Math.abs(i-o),t-=r):t+=.25}return Math.round(100*t)/100}function y(e){for(var n=0,r=0;r<e.length;r++){var t=e[r];t>0&&(n+=t)}return n}function S(){if(X()){var e=Y();e!==-1&&L(!1,e)}else L(!1)}function L(n,r){var t,a;angular.isUndefined(r)?(t=0,a=e.songsIndexesList[0]):(t=e.songsIndexesList.indexOf(r),a=r),e.currentPlayingSongIndex=a;var s;s=I(n,r)?e.songsIndexesList.splice(t,1):e.songsIndexesList.splice(0,t+1);var i,o,u;for(i=0,o=s.length;i<o;i++)u=s[i],e.alreadyPlayedSongsIndexesListSingleCycle.push(u);G(),n||e.$apply()}function I(e,n){return!e&&angular.isDefined(n)}function G(){var n=e.genreWeightsDistancesList.slice();n=M(n);for(var r=[],t=[],a=0;a<n.length;a++){var s=n[a];s.score<J()?t.push(s.index):r.push(s)}var i=r.length;if(i<=10){for(var o=[],u=0;u<n.length;u++){var g=n[u];o.push(g)}r=o}r.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var c=[],l=new Date,f=(l.getDay()+1)*(l.getMonth()+1);r.sort(function(e,n){var r;if(D(e.index)&&!D(n.index))return 1;if(!D(e.index)&&D(n.index))return-1;if(r=n.score-e.score,0!==r)return r;var t=e.index%f,a=n.index%f;return a-t});for(var d=0;d<r.length;d++)c.push(r[d].index);var p=[];p=c.concat(t),e.songsIndexesList=p}function M(n){var r=e.userTagsMap;if(!w(r))return n;var t=e.rawSongsList,a=n.filter(function(e){var n=t[e.index].t;return m(n,r)});return a}function m(e,n){for(var r=!0,t=0;t<n.length;t++){var a=n[t];1===a&&(r=r&&1===e[b(te[t])])}return r}function w(e){for(var n=0;n<e.length;n++)if(1===e[n])return!0;return!1}function D(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function N(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function O(n,r){e.userTagsMap[te.indexOf(n)]=ee(r)}function P(e,n){G()}function b(e){switch(e){case"New":return"n";case"Hit":return"h";case"Trending":return"t";default:return console.error("couldn't find tag short name | tag name: "+e),"n"}}function U(n,r){e.userGenresMap[re.indexOf(n)]=r,a();for(var t=F(),s=e.genreWeightsDistancesList.length,i=0;i<s;i++){var o=e.genreWeightsDistancesList[i],u=T(i),g=x(u,t);o.score=g,e.genreWeightsDistancesList[i]=o}G()}function T(e){var n=W(e),r=n.g;return r}function W(n){return e.rawSongsList[n]}function k(){return e.currentPlayingSongIndex}function A(n){var r=e.rawSongsList[n];return r.s}function B(n){var r=e.rawSongsList[n];return r.a}function C(){return V(F())}function F(){return"undefined"!=typeof e.userGenresMap&&"undefined"!=e.userGenresMap&&null!==e.userGenresMap?e.userGenresMap:(console.error("$rootScope.userGenresMap was npt defined, $rootScope.userGenresMap: "+e.userGenresMap),e.userGenresMap=ae,e.userGenresMap)}function V(e){for(var n=[],r=0;r<e.length;r++)currentGenreEntry=e[r],currentGenreEntry!==-1&&n.push(re[r]);return n}function $(n){for(var r=[],t=0;t<re.length;t++)if(currentGenreName=re[t],n.indexOf(currentGenreName)>-1){var a=e.userGenresMap[t];a===-1?r.push(ne):r.push(a)}else r.push(-1);return r}function R(n){e.userGenresMap=$(n)}function E(){return re}function H(n){return e.userGenresMap[re.indexOf(n)]}function j(n){return _(e.userTagsMap[te.indexOf(n)])}function J(){return e.weightDistanceFactor}function q(){for(var n=e.userGenresMap,r=0;r<n.length;r++)currentGenreWeight=n[r],currentGenreName=re[r],currentGenreWeight!==-1?U(currentGenreName,currentGenreWeight):U(currentGenreName,-1)}function z(){var n=K(),r=e.rawSongsList;if(e.urlVideoId="",e.urlVideoIdIndex=-1,""!==n)for(var t=0;t<r.length;t++){var a=r[t];if(a.id===n){e.urlVideoId=n,e.urlVideoIdIndex=a.i;break}}}function K(){var e=window.location.search.slice(1);if(e){e=e.split("#")[0];for(var n=e.split("&"),r=0;r<n.length;r++){var t=n[r].split("=");if(t[0]===oe)return t[1]}}return e}function Q(){return e.urlVideoId}function X(){var e=Q();return Z(e)&&""!==e}function Y(){return e.urlVideoIdIndex}function Z(e){return"undefined"!=typeof e&&"undefined"!=e&&null!==e}function _(e){return!!e}function ee(e){return e?1:0}var ne=3,re=["Alternative","Chill Out","Country","Dance","Folk","Funk","Hip-Hop","Indie","Latin","Love","Metal","Pop","Punk","R&B","Rap","Reggae","Reggaeton","Rock","Soul","Trance"],te=["New","Hit","Trending"],ae=[3,-1,-1,2,-1,-1,-1,3,-1,-1,-1,4,-1,-1,-1,-1,-1,-1,-1,-1],se=[0,0,0],ie="mm-data-genrestags",oe="v",ue=5,ge={initCalcSongsList:t,initUserData:s,getSongsIndexesList:d,getUserGenresNames:C,setSelectedGenresByNames:R,getWeightOfGenre:H,getTagStateByName:j,geAllGenresNames:E,popSongIndexFromListAndUpdate:L,getNextSongId:N,updateGenreWeightsDistancesList:U,updateGenreWeightsDistancesListByCurrentWidget:q,updateSongIndexesListByTagIfNeeded:P,getCurrentPlayingSongIndex:k,updateSongsIndexesList:G,initUrlParams:z,getSongNameByIndex:A,getSongArtistByIndex:B,updateWeightDistanceFactor:a,updateUserTagsMap:O,setNewUserGenresAndTagsData:f};return ge}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","dpSongsListUtils","$location"];