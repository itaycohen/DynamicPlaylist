function dpSongsListLogic(e,n){function r(){o(),g(),u(),U(),f()}function t(){if(localStorage){var n=localStorage.getItem("mm-data-genres");if("undefined"==typeof n||"undefined"==n||null===n){e.userGenresMap=J;var r={};return r=JSON.stringify(J),void localStorage.setItem("mm-data-genres",r)}var t=JSON.parse(n);if(s(t))return void(e.userGenresMap=t)}e.userGenresMap=J}function s(e){return!0}function i(){var n=JSON.stringify(e.userGenresMap);localStorage.setItem("mm-data-genres",n)}function a(){return e.songsIndexesList}function o(){var n=e.rawSongsList.length,r=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=r}function g(){for(var n=[],r=e.rawSongsList,t=r.length,s=0;s<t;s++){var i=r[s],a=i.g,o=c(a,!0),g=d(a);n.push({index:s,avgDistance:o,genreWeightsDistance:g})}e.genreWeightsDistancesList=n}function u(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function c(e,n){var r=0,t=0;for(var s in e){var i=e[s];n&&(i=l(i)),r+=i,t++}return r/t}function d(e){for(var n=[],r=0;r<e.length;r++)n[r]=l(e[r]);return n}function l(e){return Math.abs(e-A)}function f(){p(!1)}function p(n,r){var t,s;angular.isUndefined(r)?(t=0,s=e.songsIndexesList[0]):(t=e.songsIndexesList.indexOf(r),s=r),e.currentPlayingSongIndex=s;var i,a,o,g=e.songsIndexesList.splice(0,t+1);for(i=0,a=g.length;i<a;i++)o=g[i],e.alreadyPlayedSongsIndexesListSingleCycle.push(o);S(),n||e.$apply()}function S(){for(var n=(e.alreadyPlayedSongsIndexesListSingleCycle[e.alreadyPlayedSongsIndexesListSingleCycle.length-1],e.genreWeightsDistancesList.slice()),r=[],t=[],s=0;s<n.length;s++){var i=n[s];i.avgDistance>B?t.push(i.index):r.push(i)}r.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var a=[],o=new Date,g=o.getDay()*o.getMonth();r.sort(function(e,n){var r;if(L(e.index)&&!L(n.index))return 1;if(!L(e.index)&&L(n.index))return-1;if(r=e.avgDistance-n.avgDistance,0!==r)return r;var t=e.index%g,s=n.index%g;return t-s});for(var u=0;u<r.length;u++)a.push(r[u].index);var c=[];c=a.concat(t),e.songsIndexesList=c}function L(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function v(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function h(n,r){for(var t=e.genreWeightsDistancesList.length,s=0;s<t;s++){var i=e.genreWeightsDistancesList[s],a=y(s,n),o=Math.abs(a-r),g=b.indexOf(n);i.genreWeightsDistance[g]=o;var u=c(i.genreWeightsDistance,!1);i.avgDistance=u,e.genreWeightsDistancesList[s]=i}S(),e.userGenresMap[b.indexOf(n)]=r}function y(e,n){var r=x(e),t=b.indexOf(n),s=r[t];return s}function x(e){var n=G(e),r=n.g;return r}function G(n){return e.rawSongsList[n]}function I(){return e.currentPlayingSongIndex}function m(n){var r=e.rawSongsList[n];return r.s}function M(n){var r=e.rawSongsList[n];return r.a}function D(){return W(N())}function N(){return"undefined"!=typeof e.userGenresMap&&"undefined"!=e.userGenresMap&&null!==e.userGenresMap?e.userGenresMap:(console.error("$rootScope.userGenresMap was npt defined, $rootScope.userGenresMap: "+e.userGenresMap),e.userGenresMap=J,e.userGenresMap)}function W(e){for(var n=[],r=0;r<e.length;r++)currentGenreEntry=e[r],currentGenreEntry!==-1&&n.push(b[r]);return n}function P(n){for(var r=[],t=0;t<b.length;t++)if(currentGenreName=b[t],n.indexOf(currentGenreName)>-1){var s=e.userGenresMap[t];s===-1?r.push($):r.push(s)}else r.push(-1);return r}function O(n){e.userGenresMap=P(n)}function C(){return b}function w(n){return e.userGenresMap[b.indexOf(n)]}function U(){for(var n=e.userGenresMap,r=0;r<n.length;r++)currentGenreWeight=n[r],currentGenreName=b[r],currentGenreWeight!==-1?h(currentGenreName,currentGenreWeight):h(currentGenreName,-1)}var A=2.5,B=1.8,$=3,b=["Pop","Alternative","Dance","R&B","Latin","Soul","Hip-Hop"],J=[3,-1,3,3,-1,-1,-1],E={initCalcSongsList:r,initUserData:t,getSongsIndexesList:a,getUserGenresNames:D,setSelectedGenresByNames:O,getWeightOfGenre:w,geAllGenresNames:C,popSongIndexFromListAndUpdate:p,getNextSongId:v,updateGenreWeightsDistancesList:h,updateGenreWeightsDistancesListByCurrentWidget:U,getCurrentPlayingSongIndex:I,updateSongsIndexesList:S,getSongNameByIndex:m,getSongArtistByIndex:M,storeUserGenresData:i};return E}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","dpSongsListUtils"];