function dpSongsListLogic(e,n){function r(){v(),t(),S(),y(),x(),re(),m()}function t(){for(var n,r=0,t=K(),a=0;a<t.length;a++)t[a]>0&&r++;switch(r){case 1:n=6.5;break;case 2:n=7;break;case 3:n=9;break;case 4:n=10;break;case 5:n=11;break;default:n=7}e.weightDistanceFactor=n}function a(){if(localStorage){var n=localStorage.getItem(Le);if(le(n)){var r;try{if(r=JSON.parse(n),o(r))return e.userGenresMap=r.genres,void(e.userTagsMap=r.tags);d()}catch(e){console.error("Error: "+e+" | Unable to parse local storage data. value: "+n)}}else d()}else d()}function s(e){for(var n=0,r=0;r<e.length;r++){var t=e[r];0===t&&(e[r]=-1),t>0&&n++}var a=[];if(n>me){for(var s=0;s<e.length;s++){var i={};i={i:s,g:e[s]},a[s]=i}a.sort(function(e,n){return e.g-n.g});for(var o=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,-1),u=0;u<5;u++)topGenreArrPair=a[a.length-(u+1)],o[topGenreArrPair.i]=topGenreArrPair.g;return o}return e}function i(n){var r=e.rawSongsList,t=oe();if(songDataByIndexOfUrl=r[oe()],t===songDataByIndexOfUrl.i)return[songDataByIndexOfUrl.g,songDataByIndexOfUrl.t];console.error("the index in the array of all songs is not the same as in the song data");for(var a;a<r.length;a++){var s=r[a];if(s.id===n)return[s.g,s.t]}}function o(e){return u(e.genres)&&g(e.tags)}function u(e){return c(e)&&e.length===ve.length}function g(e){return l(e)&&Object.keys(e).length===Se.length}function c(e){var n=[].constructor;return e.constructor===n}function l(e){var n={}.constructor;return e.constructor===n}function d(){if(ie()){var e=i(se());f(s(e[0]),e[1]),localStorage&&p()}else f(ye,xe),localStorage&&p()}function f(n,r){e.userGenresMap=n,e.userTagsMap=r}function p(){var n={};n.genres=e.userGenresMap,n.tags=e.userTagsMap;try{localStorage.setItem(Le,JSON.stringify(n))}catch(e){console.error("Error: "+e+" | Unable to set item to local storage data")}}function h(){return e.songsIndexesList}function v(){var n=e.rawSongsList.length,r=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=r}function S(){for(var n=[],r=e.rawSongsList,t=r.length,a=K(),s=0;s<t;s++){var i=r[s],o=i.g,u=L(o,a);n.push({index:s,score:u})}e.genreWeightsDistancesList=n}function y(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function x(){e.alreadyPlayedSongsIndexesListAll=[]}function L(e,n){for(var r=0,t=0,a=I(e),s=0;s<n.length;s++){var i=n[s],o=e[s];if(i>0&&o>0){r=Math.pow(5-Math.abs(i-o),2);var u=a>0?o/a:1;t+=i===o?(r+10)*u:r*u}else 0!==i&&i!==-1||0!==o?0!==i&&0!==o||(r=5-Math.abs(i-o),t-=r):t+=.25}return Math.round(100*t)/100}function I(e){for(var n=0,r=0;r<e.length;r++){var t=e[r];t>0&&(n+=t)}return n}function m(){if(ie()){var e=oe();e!==-1&&G(!1,e)}else G(!1)}function G(n,r){M();var t,a,s=!1;angular.isUndefined(r)?(t=0,a=e.songsIndexesList[0]):(s=!n,t=e.songsIndexesList.indexOf(r),a=r),s||O(a),e.currentPlayingSongIndex=a;var i;i=A(n,r)?e.songsIndexesList.splice(t,1):e.songsIndexesList.splice(0,t+1);var o,u,g;for(o=0,u=i.length;o<u;o++)g=i[o],e.alreadyPlayedSongsIndexesListSingleCycle.push(g);T(),n||e.$apply()}function M(){angular.isDefined(e.currentPlayingSongIndex)&&e.alreadyPlayedSongsIndexesListAll.push(e.currentPlayingSongIndex)}function w(){return e.alreadyPlayedSongsIndexesListAll.length>0}function P(){e.songsIndexesList.unshift(e.currentPlayingSongIndex);var n=e.alreadyPlayedSongsIndexesListAll.pop();O(n),e.currentPlayingSongIndex=n}function D(){var n=e.lastPlayedSongIndex;return e.rawSongsList[n].id}function N(){Ge=!Ge}function b(){return Ge}function A(e,n){return!e&&angular.isDefined(n)}function O(r){var t="",a=e.rawSongsList,s=a[r];if(r===s.i)t=s.id;else{consolo.error("the index in the array of all songs is not the same as in the song data");for(var i;i<a.length;i++){var o=a[i];o.i===r&&(t=o.id)}}n.search(Ie+"="+t)}function T(){var n=e.genreWeightsDistancesList.slice();n=W(n);for(var r=[],t=[],a=0;a<n.length;a++){var s=n[a];s.score<ne()?t.push(s.index):r.push(s)}var i=r.length;if(i<=10){for(var o=[],u=0;u<n.length;u++){var g=n[u];o.push(g)}r=o}r.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var c=[],l=new Date,d=(l.getDay()+1)*(l.getMonth()+1);r.sort(function(e,n){var r;if(U(e.index)&&!U(n.index))return 1;if(!U(e.index)&&U(n.index))return-1;if(r=n.score-e.score,Math.abs(r)>.1)return r;var t=e.index%d,a=n.index%d;return a-t});for(var f=0;f<r.length;f++)c.push(r[f].index);var p=[];p=c.concat(t),e.songsIndexesList=p}function W(n){var r=e.userTagsMap;if(!B(r))return n;var t=e.rawSongsList,a=n.filter(function(e){var n=t[e.index].t;return k(n,r)});return a}function k(e,n){var r=!0;for(tagName in n){var t=n[tagName];1===t&&(r=r&&1===e[tagName])}return r}function B(e){for(tag in e)if(1===e[tag])return!0;return!1}function U(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function C(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function R(n,r){e.userTagsMap[H(n)]=fe(r)}function F(e,n){T()}function H(e){switch(e){case"New":return"n";case"Hits":return"h";case"Trending":return"t";default:return console.error("couldn't find tag short name | tag name: "+e),"n"}}function V(n,r){e.userGenresMap[ve.indexOf(n)]=r,t();for(var a=K(),s=e.genreWeightsDistancesList.length,i=0;i<s;i++){var o=e.genreWeightsDistancesList[i],u=$(i),g=L(u,a);o.score=g,e.genreWeightsDistancesList[i]=o}T()}function $(e){var n=E(e),r=n.g;return r}function E(n){return e.rawSongsList[n]}function j(){return e.currentPlayingSongIndex}function J(n){var r=e.rawSongsList[n];return r.s}function z(n){var r=e.rawSongsList[n];return r.a}function q(){return Q(K())}function K(){return"undefined"!=typeof e.userGenresMap&&"undefined"!=e.userGenresMap&&null!==e.userGenresMap?e.userGenresMap:(console.error("$rootScope.userGenresMap was npt defined, $rootScope.userGenresMap: "+e.userGenresMap),e.userGenresMap=ye,e.userGenresMap)}function Q(e){for(var n=[],r=0;r<e.length;r++)currentGenreEntry=e[r],currentGenreEntry!==-1&&n.push(ve[r]);return n}function X(n){for(var r=[],t=0;t<ve.length;t++)if(currentGenreName=ve[t],n.indexOf(currentGenreName)>-1){var a=e.userGenresMap[t];a===-1?r.push(he):r.push(a)}else r.push(-1);return r}function Y(n){e.userGenresMap=X(n)}function Z(){return ve}function _(n){return e.userGenresMap[ve.indexOf(n)]}function ee(n){return de(e.userTagsMap[H(n)])}function ne(){return e.weightDistanceFactor}function re(){for(var n=e.userGenresMap,r=0;r<n.length;r++)currentGenreWeight=n[r],currentGenreName=ve[r],currentGenreWeight!==-1?V(currentGenreName,currentGenreWeight):V(currentGenreName,-1)}function te(){var n=ae(),r=e.rawSongsList;if(e.urlVideoId="",e.urlVideoIdIndex=-1,""!==n)for(var t=0;t<r.length;t++){var a=r[t];if(a.id===n){e.urlVideoId=n,e.urlVideoIdIndex=a.i;break}}}function ae(){var e=window.location.search.slice(1);if(e){e=e.split("#")[0];for(var n=e.split("&"),r=0;r<n.length;r++){var t=n[r].split("=");if(t[0]===Ie)return t[1]}}return e}function se(){return e.urlVideoId}function ie(){var e=se();return le(e)&&""!==e}function oe(){return e.urlVideoIdIndex}function ue(n){var r=e.rawSongsList[n];return ce(r.w)}function ge(n){return e.rawSongsList[n].d}function ce(e){return"http://is"+e[0]+".mzstatic.com/image/thumb/Music"+e[1]+"/v"+e[2]+"/"+e[3]+"/"+e[4]+"/"+e[5]+"/"+e[6]+"/source/60x60bb.jpg"}function le(e){return"undefined"!=typeof e&&"undefined"!=e&&null!==e}function de(e){return!!e}function fe(e){return e?1:0}function pe(e){var n=new Date;console.log("component: "+e+" time: "+n.getSeconds()+":"+n.getMilliseconds())}var he=3,ve=["Alternative","Classic Rock","Country","Dance","Electronic","Folk","Funk","Hard Rock","Hip-Hop","House","Indie","Latin","Metal","Pop","Punk","R&B","Rap","Reggae","Reggaeton","Rock","Soul","Trance"],Se=["New","Hits","Trending"],ye=[3,-1,-1,-1,2,-1,-1,-1,-1,-1,1,-1,-1,4,-1,-1,-1,-1,-1,-1,-1,-1],xe={n:0,h:1,t:0},Le="mm-data-genrestags",Ie="v",me=5,Ge=!1,Me={initCalcSongsList:r,initUserData:a,getSongsIndexesList:h,getUserGenresNames:q,setSelectedGenresByNames:Y,getWeightOfGenre:_,getTagStateByName:ee,geAllGenresNames:Z,popSongIndexFromListAndUpdate:G,getNextSongId:C,playLastPlayedSong:P,isAnySongWasPlayed:w,getLastPlayedSongId:D,switchRepeatSongToggle:N,isRepeatSongOn:b,updateGenreWeightsDistancesList:V,updateGenreWeightsDistancesListByCurrentWidget:re,updateSongIndexesListByTagIfNeeded:F,getCurrentPlayingSongIndex:j,updateSongsIndexesList:T,initUrlParams:te,getSongNameByIndex:J,getSongArtistByIndex:z,updateWeightDistanceFactor:t,updateUserTagsMap:R,storeUserGenresAndTagsData:p,getSongImgSrcByIndex:ue,getSongDurationByIndex:ge,printTime:pe};return Me}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","$location"];