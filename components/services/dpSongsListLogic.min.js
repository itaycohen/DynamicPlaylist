function dpSongsListLogic(e,n){function t(){o(),d(),c(),U(),e.selectedGenres=W(),S()}function r(){if(localStorage){window.onbeforeunload=i;var e=localStorage.getItem("mm-data-genres");if("undefined"==typeof e||"undefined"==e||null===e){var n={};return n=JSON.stringify(J),void localStorage.setItem("mm-data-genres",n)}var t=JSON.parse(e);if(s(t))return void(B=t)}B=J}function s(e){return!0}function i(){var n=JSON.stringify(e.selectedGenres);localStorage.setItem("mm-data-genres",n)}function a(){return e.rawSongsList}function g(){return e.songsIndexesList}function o(){var n=e.rawSongsList.length,t=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=t}function d(){for(var n=[],t=e.rawSongsList,r=t.length,s=0;s<r;s++){var i=t[s],a=i.g,g=l(a,!0),o=u(a);n.push({index:s,avgDistance:g,genreWeightsDistance:o})}e.genreWeightsDistancesList=n}function c(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function l(e,n){var t=0,r=0;for(var s in e){var i=e[s];n&&(i=f(i)),t+=i,r++}return t/r}function u(e){for(var n=[],t=0;t<e.length;t++)n[t]=f(e[t]);return n}function f(e){return Math.abs(e-b)}function S(){L(!1)}function L(n,t){var r,s;angular.isUndefined(t)?(r=0,s=e.songsIndexesList[0]):(r=e.songsIndexesList.indexOf(t),s=t),e.currentPlayingSongIndex=s;var i,a,g,o=e.songsIndexesList.splice(0,r+1);for(i=0,a=o.length;i<a;i++)g=o[i],e.alreadyPlayedSongsIndexesListSingleCycle.push(g);v(),n||e.$apply()}function v(){for(var n=(e.alreadyPlayedSongsIndexesListSingleCycle[e.alreadyPlayedSongsIndexesListSingleCycle.length-1],e.genreWeightsDistancesList.slice()),t=[],r=[],s=0;s<n.length;s++){var i=n[s];i.avgDistance>H?r.push(i.index):t.push(i)}t.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var a=[],g=new Date,o=g.getDay()*g.getMonth();t.sort(function(e,n){var t;if(x(e.index)&&!x(n.index))return 1;if(!x(e.index)&&x(n.index))return-1;if(t=e.avgDistance-n.avgDistance,0!==t)return t;var r=e.index%o,s=n.index%o;return r-s});for(var d=0;d<t.length;d++)a.push(t[d].index);var c=[];c=a.concat(r),e.songsIndexesList=c}function x(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function y(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function h(n,t){for(var r=e.genreWeightsDistancesList.length,s=0;s<r;s++){var i=e.genreWeightsDistancesList[s],a=p(s,n),g=Math.abs(a-t),o=M.indexOf(n);i.genreWeightsDistance[o]=g;var d=l(i.genreWeightsDistance,!1);i.avgDistance=d,e.genreWeightsDistancesList[s]=i}v()}function p(e,n){var t=I(e),r=M.indexOf(n),s=t[r];return s}function I(e){var n=D(e),t=n.g;return t}function D(n){return e.rawSongsList[n]}function G(){return e.currentPlayingSongIndex}function m(n){var t=e.rawSongsList[n];return t.a+" - "+t.s}function P(n){var t=e.rawSongsList[n];return t.s}function w(n){var t=e.rawSongsList[n];return t.a}function W(){return e.selectedGenres=B?B:J,e.selectedGenres}function C(){return angular.isUndefined(e.selectedGenres)?J:e.selectedGenres}function N(n){e.selectedGenres=n}function O(){return M}function A(){var n=e.selectedGenres;angular.isUndefined(n)&&(n=W());var t=M.filter(function(e){return n.indexOf(e)<0});return t}function U(){for(var e=C(),n=0;n<e.length;n++)selectedGenre=e[n],h(selectedGenre,3);for(var t=A(),r=0;r<t.length;r++)hiddenGenre=t[r],h(hiddenGenre,0)}var B,b=2.5,H=1.8,J=["Pop","R&B","Dance"],M=["Pop","Alternative","Dance","R&B","Latin","Soul","Hip-Hop"],R={initCalcSongsList:t,initUserData:r,getRawSongsList:a,getSongsIndexesList:g,getUserSelectedGenres:W,getSelectedGenres:C,setSelectedGenres:N,getHiddenGenres:A,geAllGenres:O,popSongIndexFromListAndUpdate:L,getNextSongId:y,updateGenreWeightsDistancesList:h,updateGenreWeightsDistancesListByCurrentWidget:U,getCurrentPlayingSongIndex:G,updateSongsIndexesList:v,getSongArtistAndNameByIndex:m,getSongNameByIndex:P,getSongArtistByIndex:w};return R}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","dpSongsListUtils"];