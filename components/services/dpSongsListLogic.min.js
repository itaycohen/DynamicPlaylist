function dpSongsListLogic(e,n){function t(){o(),u(),d(),A(),S()}function r(){if(localStorage){window.onbeforeunload=i;var n=localStorage.getItem("mm-data-genres");if("undefined"==typeof n||"undefined"==n||null===n){e.userGenresMap=B;var t={};return t=JSON.stringify(B),void localStorage.setItem("mm-data-genres",t)}var r=JSON.parse(n);if(s(r))return void(e.userGenresMap=r)}e.userGenresMap=B}function s(e){return!0}function i(){var n=JSON.stringify(e.userGenresMap);localStorage.setItem("mm-data-genres",n)}function a(){return e.rawSongsList}function g(){return e.songsIndexesList}function o(){var n=e.rawSongsList.length,t=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=t}function u(){for(var n=[],t=e.rawSongsList,r=t.length,s=0;s<r;s++){var i=t[s],a=i.g,g=c(a,!0),o=l(a);n.push({index:s,avgDistance:g,genreWeightsDistance:o})}e.genreWeightsDistancesList=n}function d(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function c(e,n){var t=0,r=0;for(var s in e){var i=e[s];n&&(i=f(i)),t+=i,r++}return t/r}function l(e){for(var n=[],t=0;t<e.length;t++)n[t]=f(e[t]);return n}function f(e){return Math.abs(e-U)}function S(){L(!1)}function L(n,t){var r,s;angular.isUndefined(t)?(r=0,s=e.songsIndexesList[0]):(r=e.songsIndexesList.indexOf(t),s=t),e.currentPlayingSongIndex=s;var i,a,g,o=e.songsIndexesList.splice(0,r+1);for(i=0,a=o.length;i<a;i++)g=o[i],e.alreadyPlayedSongsIndexesListSingleCycle.push(g);v(),n||e.$apply()}function v(){for(var n=(e.alreadyPlayedSongsIndexesListSingleCycle[e.alreadyPlayedSongsIndexesListSingleCycle.length-1],e.genreWeightsDistancesList.slice()),t=[],r=[],s=0;s<n.length;s++){var i=n[s];i.avgDistance>b?r.push(i.index):t.push(i)}t.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var a=[],g=new Date,o=g.getDay()*g.getMonth();t.sort(function(e,n){var t;if(p(e.index)&&!p(n.index))return 1;if(!p(e.index)&&p(n.index))return-1;if(t=e.avgDistance-n.avgDistance,0!==t)return t;var r=e.index%o,s=n.index%o;return r-s});for(var u=0;u<t.length;u++)a.push(t[u].index);var d=[];d=a.concat(r),e.songsIndexesList=d}function p(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function x(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function y(n,t){for(var r=e.genreWeightsDistancesList.length,s=0;s<r;s++){var i=e.genreWeightsDistancesList[s],a=h(s,n),g=Math.abs(a-t),o=H.indexOf(n);i.genreWeightsDistance[o]=g;var u=c(i.genreWeightsDistance,!1);i.avgDistance=u,e.genreWeightsDistancesList[s]=i}v()}function h(e,n){var t=I(e),r=H.indexOf(n),s=t[r];return s}function I(e){var n=G(e),t=n.g;return t}function G(n){return e.rawSongsList[n]}function m(){return e.currentPlayingSongIndex}function D(n){var t=e.rawSongsList[n];return t.a+" - "+t.s}function M(n){var t=e.rawSongsList[n];return t.s}function w(n){var t=e.rawSongsList[n];return t.a}function P(){return C(N())}function N(){return consoloe.log(e.userGenresMap),e.userGenresMap?e.userGenresMap:B}function C(e){for(var n=[],t=0;t<e.length;t++)currentGenreEntry=e[t],"-1"!==currentGenreEntry&&n.push(H[t]);return n}function W(){return H}function O(){var n=e.userGenresMap;angular.isUndefined(n)&&(n=N());var t=H.filter(function(e){return n.indexOf(e)<0});return t}function A(){for(var n=e.userGenresMap,t=0;t<n.length;t++)selectedGenre=n[t],y(selectedGenre,3);for(var r=O(),s=0;s<r.length;s++)hiddenGenre=r[s],y(hiddenGenre,0)}var U=2.5,b=1.8,B=[3,-1,3,3,-1,-1,-1],H=["Pop","Alternative","Dance","R&B","Latin","Soul","Hip-Hop"],J={initCalcSongsList:t,initUserData:r,getRawSongsList:a,getSongsIndexesList:g,getUserGenresMap:N,getUserGenresNames:P,setSelectedGenres:setSelectedGenres,getHiddenGenres:O,geAllGenresNames:W,popSongIndexFromListAndUpdate:L,getNextSongId:x,updateGenreWeightsDistancesList:y,getCurrentPlayingSongIndex:m,updateSongsIndexesList:v,getSongArtistAndNameByIndex:D,getSongNameByIndex:M,getSongArtistByIndex:w};return J}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","dpSongsListUtils"];