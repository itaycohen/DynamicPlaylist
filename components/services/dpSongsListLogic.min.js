function dpSongsListLogic(e,n){function r(){l(),t(),p(),h(),j(),L()}function t(){for(var n,r=0,t=A(),s=0;s<t.length;s++)t[s]>0&&r++;switch(r){case 1:n=6.5;break;case 2:n=7;break;case 3:n=9;break;case 4:n=10;break;case 5:n=11;break;default:n=7}e.weightDistanceFactor=n}function s(){if(a()){var e=getVideoGenreAndTagsPairArr();i(e,!0)}else i([X,Y],!1)}function a(){return!1}function i(n,r){if(e.userGenresMap=n[0],e.userTagsMap=n[1],localStorage){if(!r){var t=localStorage.getItem(Z);if(o(t)){var s;try{if(s=JSON.parse(t),u(s))return e.userGenresMap=s.genres,void(e.userTagsMap=s.tags);f()}catch(e){console.error("Error: "+e+" | Unable to parse local storage data. value: "+t)}}}f()}}function o(e){return"undefined"!=typeof e&&"undefined"!=e&&null!==e}function u(e){return g(e.genres)&&c(e.tags)}function g(e){return e.length===K.length}function c(e){return e.length===Q.length}function f(){var n={};n.genres=e.userGenresMap,n.tags=e.userTagsMap;try{localStorage.setItem(Z,JSON.stringify(n))}catch(e){console.error("Error: "+e+" | Unable to set item to local storage data")}}function d(){return e.songsIndexesList}function l(){var n=e.rawSongsList.length,r=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=r,e.filteredSongsIndexesList=r}function p(){for(var n=[],r=e.rawSongsList,t=r.length,s=A(),a=0;a<t;a++){var i=r[a],o=i.g,u=v(o,s);n.push({index:a,score:u})}e.genreWeightsDistancesList=n}function h(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function v(e,n){for(var r=0,t=0,s=S(e),a=0;a<n.length;a++){var i=n[a],o=e[a];if(i>0&&o>0){r=Math.pow(5-Math.abs(i-o),2);var u=s>0?o/s:1;t+=i===o?(r+10)*u:r*u}else 0!==i&&i!==-1||0!==o?0!==i&&0!==o||(r=5-Math.abs(i-o),t-=r):t+=.25}return Math.round(100*t)/100}function S(e){for(var n=0,r=0;r<e.length;r++){var t=e[r];t>0&&(n+=t)}return n}function L(){x(!1)}function x(n,r){var t,s;angular.isUndefined(r)?(t=0,s=e.songsIndexesList[0]):(t=e.songsIndexesList.indexOf(r),s=r),e.currentPlayingSongIndex=s;var a,i,o,u=e.songsIndexesList.splice(0,t+1);for(a=0,i=u.length;a<i;a++)o=u[a],e.alreadyPlayedSongsIndexesListSingleCycle.push(o);y(),n||e.$apply()}function y(){var n=e.genreWeightsDistancesList.slice();n=G(n);for(var r=[],t=[],s=0;s<n.length;s++){var a=n[s];a.score<J()?t.push(a.index):r.push(a)}var i=r.length;if(i<=10){for(var o=[],u=0;u<n.length;u++){var g=n[u];o.push(g)}r=o}r.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var c=[],f=new Date,d=(f.getDay()+1)*(f.getMonth()+1);r.sort(function(e,n){var r;if(m(e.index)&&!m(n.index))return 1;if(!m(e.index)&&m(n.index))return-1;if(r=n.score-e.score,0!==r)return r;var t=e.index%d,s=n.index%d;return s-t});for(var l=0;l<r.length;l++)c.push(r[l].index);var p=[];p=c.concat(t),e.songsIndexesList=p}function G(n){var r=e.userTagsMap;if(!I(r))return n;var t=e.rawSongsList,s=n.filter(function(e){var n=t[e.index].t;return M(n,r)});return s}function M(e,n){for(var r=!0,t=0;t<n.length;t++){var s=n[t];1===s&&(r=r&&1===e[T(Q[t])])}return r}function I(e){for(var n=0;n<e.length;n++)if(1===e[n])return!0;return!1}function m(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function N(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function w(n,r){e.userTagsMap[Q.indexOf(n)]=q(r)}function D(e,n){y()}function T(e){switch(e){case"New":return"n";case"Hit":return"h";case"Trending":return"t";default:return console.error("couldn't find tag short name | tag name: "+e),"n"}}function W(n,r){e.userGenresMap[K.indexOf(n)]=r,t();for(var s=A(),a=e.genreWeightsDistancesList.length,i=0;i<a;i++){var o=e.genreWeightsDistancesList[i],u=P(i),g=v(u,s);o.score=g,e.genreWeightsDistancesList[i]=o}y()}function P(e){var n=b(e),r=n.g;return r}function b(n){return e.rawSongsList[n]}function O(){return e.currentPlayingSongIndex}function C(n){var r=e.rawSongsList[n];return r.s}function k(n){var r=e.rawSongsList[n];return r.a}function U(){return B(A())}function A(){return"undefined"!=typeof e.userGenresMap&&"undefined"!=e.userGenresMap&&null!==e.userGenresMap?e.userGenresMap:(console.error("$rootScope.userGenresMap was npt defined, $rootScope.userGenresMap: "+e.userGenresMap),e.userGenresMap=X,e.userGenresMap)}function B(e){for(var n=[],r=0;r<e.length;r++)currentGenreEntry=e[r],currentGenreEntry!==-1&&n.push(K[r]);return n}function F(n){for(var r=[],t=0;t<K.length;t++)if(currentGenreName=K[t],n.indexOf(currentGenreName)>-1){var s=e.userGenresMap[t];s===-1?r.push(z):r.push(s)}else r.push(-1);return r}function R(n){e.userGenresMap=F(n)}function $(){return K}function E(n){return e.userGenresMap[K.indexOf(n)]}function H(n){return V(e.userTagsMap[Q.indexOf(n)])}function J(){return e.weightDistanceFactor}function j(){for(var n=e.userGenresMap,r=0;r<n.length;r++)currentGenreWeight=n[r],currentGenreName=K[r],currentGenreWeight!==-1?W(currentGenreName,currentGenreWeight):W(currentGenreName,-1)}function V(e){return!!e}function q(e){return e?1:0}var z=3,K=["Alternative","Chill Out","Country","Dance","Folk","Funk","Hip-Hop","Indie","Latin","Love","Metal","Pop","Punk","R&B","Rap","Reggae","Reggaeton","Rock","Soul","Trance"],Q=["New","Hit","Trending"],X=[3,-1,-1,2,-1,-1,-1,3,-1,-1,-1,4,-1,-1,-1,-1,-1,-1,-1,-1],Y=[0,0,0],Z="mm-data-genrestags",_={initCalcSongsList:r,initUserData:s,getSongsIndexesList:d,getUserGenresNames:U,setSelectedGenresByNames:R,getWeightOfGenre:E,getTagStateByName:H,geAllGenresNames:$,popSongIndexFromListAndUpdate:x,getNextSongId:N,updateGenreWeightsDistancesList:W,updateGenreWeightsDistancesListByCurrentWidget:j,updateSongIndexesListByTagIfNeeded:D,getCurrentPlayingSongIndex:O,updateSongsIndexesList:y,getSongNameByIndex:C,getSongArtistByIndex:k,updateWeightDistanceFactor:t,updateUserTagsMap:w,setNewUserGenresAndTagsData:f};return _}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","dpSongsListUtils"];