function dpSongsListLogic(e,n){function r(){p(),t(),h(),S(),q(),L()}function t(){for(var n,r=0,t=B(),a=0;a<t.length;a++)t[a]>0&&r++;switch(r){case 1:n=6.5;break;case 2:n=7;break;case 3:n=9;break;case 4:n=10;break;case 5:n=11;break;default:n=7}e.weightDistanceFactor=n}function a(){s(),o()}function s(){if(e.userGenresMap=Y,localStorage){var n=localStorage.getItem(Z);if("undefined"!=typeof n&&"undefined"!=n&&null!==n){var r;try{if(r=JSON.parse(n),i(r))return void(e.userGenresMap=r);l()}catch(e){console.error("Error: "+e+" | Unable to parse local storage data. value: "+n)}}else l()}}function o(){if(e.userTagsMap=_,localStorage){var n=localStorage.getItem(ee);if("undefined"!=typeof n&&"undefined"!=n&&null!==n){var r;try{if(r=JSON.parse(n),u(r))return void(e.userTagsMap=r);f()}catch(e){console.error("Error: "+e+" | Unable to parse local storage data. value: "+n)}}else f()}}function i(e){return e.length===V.length}function u(e){return e.length===X.length}function g(){var n=JSON.stringify(e.userGenresMap);try{localStorage.setItem(Z,n)}catch(e){console.error("Error: "+e+" | Unable to set genre map item to local storage data")}}function c(){var n=JSON.stringify(e.userTagsMap);try{localStorage.setItem(ee,n)}catch(e){console.error("Error: "+e+" | Unable to set tags map item to local storage data")}}function l(){e.userGenresMap=Y;var n={};n=JSON.stringify(Y);try{localStorage.setItem(Z,n)}catch(e){console.error("Error: "+e+" | Unable to set item to local storage data")}}function f(){e.userTagsMap=_;var n={};n=JSON.stringify(_);try{localStorage.setItem(ee,n)}catch(e){console.error("Error: "+e+" | Unable to set item to local storage data")}}function d(){return e.songsIndexesList}function p(){var n=e.rawSongsList.length,r=Array.apply(null,{length:n}).map(Number.call,Number);e.songsIndexesList=r,e.filteredSongsIndexesList=r}function h(){for(var n=[],r=e.rawSongsList,t=r.length,a=B(),s=0;s<t;s++){var o=r[s],i=o.g,u=v(i,a);n.push({index:s,score:u})}e.genreWeightsDistancesList=n}function S(){e.alreadyPlayedSongsIndexesListSingleCycle=[]}function v(e,n){for(var r=0,t=0,a=y(e),s=0;s<n.length;s++){var o=n[s],i=e[s];if(o>0&&i>0){r=Math.pow(5-Math.abs(o-i),2);var u=a>0?i/a:1;t+=o===i?(r+10)*u:r*u}else 0!==o&&o!==-1||0!==i?0!==o&&0!==i||(r=5-Math.abs(o-i),t-=r):t+=.25}return Math.round(100*t)/100}function y(e){for(var n=0,r=0;r<e.length;r++){var t=e[r];t>0&&(n+=t)}return n}function L(){x(!1)}function x(n,r){var t,a;angular.isUndefined(r)?(t=0,a=e.songsIndexesList[0]):(t=e.songsIndexesList.indexOf(r),a=r),e.currentPlayingSongIndex=a;var s,o,i,u=e.songsIndexesList.splice(0,t+1);for(s=0,o=u.length;s<o;s++)i=u[s],e.alreadyPlayedSongsIndexesListSingleCycle.push(i);G(),n||e.$apply()}function G(){var n=e.genreWeightsDistancesList.slice();n=m(n);for(var r=[],t=[],a=0;a<n.length;a++){var s=n[a];s.score<j()?t.push(s.index):r.push(s)}var o=r.length;if(o<=10){for(var i=[],u=0;u<n.length;u++){var g=n[u];i.push(g)}r=i}r.length<=e.alreadyPlayedSongsIndexesListSingleCycle.length&&(e.alreadyPlayedSongsIndexesListSingleCycle=[]);var c=[],l=new Date,f=(l.getDay()+1)*(l.getMonth()+1);r.sort(function(e,n){var r;if(N(e.index)&&!N(n.index))return 1;if(!N(e.index)&&N(n.index))return-1;if(r=n.score-e.score,0!==r)return r;var t=e.index%f,a=n.index%f;return a-t});for(var d=0;d<r.length;d++)c.push(r[d].index);var p=[];p=c.concat(t),e.songsIndexesList=p}function m(n){var r=e.userTagsMap;if(!I(r))return n;var t=e.rawSongsList,a=n.filter(function(e){var n=t[e.index].t;return M(n,r)});return a}function M(e,n){for(var r=!0,t=0;t<n.length;t++){var a=n[t];1===a&&(r=r&&1===e[O(X[t])])}return r}function I(e){for(var n=0;n<e.length;n++)if(1===e[n])return!0;return!1}function N(n){return e.alreadyPlayedSongsIndexesListSingleCycle.indexOf(n)!=-1}function w(){var n=e.currentPlayingSongIndex;return e.rawSongsList[n].id}function D(n,r){e.userTagsMap[X.indexOf(n)]=K(r)}function b(e,n){G()}function O(e){switch(e){case"New":return"n";case"Hit":return"h";case"Trending":return"t";default:return console.error("couldn't find tag short name | tag name: "+e),"n"}}function T(n,r){e.userGenresMap[V.indexOf(n)]=r,t();for(var a=B(),s=e.genreWeightsDistancesList.length,o=0;o<s;o++){var i=e.genreWeightsDistancesList[o],u=U(o),g=v(u,a);i.score=g,e.genreWeightsDistancesList[o]=i}G()}function U(e){var n=W(e),r=n.g;return r}function W(n){return e.rawSongsList[n]}function P(){return e.currentPlayingSongIndex}function C(n){var r=e.rawSongsList[n];return r.s}function k(n){var r=e.rawSongsList[n];return r.a}function E(){return F(B())}function B(){return"undefined"!=typeof e.userGenresMap&&"undefined"!=e.userGenresMap&&null!==e.userGenresMap?e.userGenresMap:(console.error("$rootScope.userGenresMap was npt defined, $rootScope.userGenresMap: "+e.userGenresMap),e.userGenresMap=Y,e.userGenresMap)}function F(e){for(var n=[],r=0;r<e.length;r++)currentGenreEntry=e[r],currentGenreEntry!==-1&&n.push(V[r]);return n}function J(n){for(var r=[],t=0;t<V.length;t++)if(currentGenreName=V[t],n.indexOf(currentGenreName)>-1){var a=e.userGenresMap[t];a===-1?r.push(Q):r.push(a)}else r.push(-1);return r}function A(n){e.userGenresMap=J(n)}function R(){return V}function $(n){return e.userGenresMap[V.indexOf(n)]}function H(n){return z(e.userTagsMap[X.indexOf(n)])}function j(){return e.weightDistanceFactor}function q(){for(var n=e.userGenresMap,r=0;r<n.length;r++)currentGenreWeight=n[r],currentGenreName=V[r],currentGenreWeight!==-1?T(currentGenreName,currentGenreWeight):T(currentGenreName,-1)}function z(e){return!!e}function K(e){return e?1:0}var Q=3,V=["Alternative","Chill Out","Country","Dance","Folk","Funk","Hip-Hop","Indie","Latin","Love","Metal","Pop","Punk","R&B","Rap","Reggae","Reggaeton","Rock","Soul","Trance"],X=["New","Hit","Trending"],Y=[3,-1,-1,3,-1,-1,-1,3,-1,-1,-1,3,-1,-1,-1,-1,-1,-1,-1,-1],Z="mm-data-genres",_=[0,0,0],ee="mm-data-tags",ne={initCalcSongsList:r,initUserData:a,getSongsIndexesList:d,getUserGenresNames:E,setSelectedGenresByNames:A,getWeightOfGenre:$,getTagStateByName:H,geAllGenresNames:R,popSongIndexFromListAndUpdate:x,getNextSongId:w,updateGenreWeightsDistancesList:T,updateGenreWeightsDistancesListByCurrentWidget:q,updateSongIndexesListByTagIfNeeded:b,getCurrentPlayingSongIndex:P,updateSongsIndexesList:G,getSongNameByIndex:C,getSongArtistByIndex:k,updateWeightDistanceFactor:t,updateUserTagsMap:D,storeUserGenresData:g,storeUserTagsData:c};return ne}angular.module("dpSongsListLogic",[]).factory("dpSongsListLogic",dpSongsListLogic),dpSongsListLogic.$inject=["$rootScope","dpSongsListUtils"];